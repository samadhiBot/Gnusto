{"hierarchy":{"paths":[["doc:\/\/GnustoEngine\/documentation\/GnustoEngine"]]},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/gnustoengine\/enhanced_action_handling"]}],"primaryContentSections":[{"kind":"content","content":[{"type":"heading","text":"Overview","anchor":"Overview","level":2},{"inlineContent":[{"type":"text","text":"This document outlines the design for enhancing the existing Gnusto engineâ€™s action handling system. The goal is to build upon the current solid foundation while introducing more powerful capabilities for dynamic content and action handling."}],"type":"paragraph"},{"anchor":"Current-Architecture-Analysis","level":2,"text":"Current Architecture Analysis","type":"heading"},{"anchor":"Existing-Components","level":3,"type":"heading","text":"Existing Components"},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Action Handling"}]}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"code":"ActionHandler","type":"codeVoice"},{"type":"text","text":" protocol with "},{"code":"perform(command:engine:)","type":"codeVoice"},{"type":"text","text":" method"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"ItemEventHandler"},{"text":" type for item-specific actions","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Well-organized action handlers for common verbs","type":"text"}],"type":"paragraph"}]}]}]},{"content":[{"inlineContent":[{"inlineContent":[{"type":"text","text":"State Management"}],"type":"strong"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"code":"GameState","type":"codeVoice"},{"type":"text","text":" class for overall game state"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"Item"},{"text":" and ","type":"text"},{"type":"codeVoice","code":"Location"},{"type":"text","text":" types with properties"}]}]},{"content":[{"inlineContent":[{"code":"AnyCodable","type":"codeVoice"},{"text":" for flexible property values","type":"text"}],"type":"paragraph"}]}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Command Processing"}]}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"Command"},{"type":"text","text":" type for representing player actions"}]}]},{"content":[{"inlineContent":[{"type":"codeVoice","code":"ScopeResolver"},{"text":" for object resolution","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"}]}]},{"type":"heading","text":"Enhancement Strategy","level":2,"anchor":"Enhancement-Strategy"},{"text":"1. Action Pipeline Enhancement","anchor":"1-Action-Pipeline-Enhancement","type":"heading","level":3},{"type":"codeListing","syntax":"swift","code":["\/\/\/ Enhanced ActionHandler protocol with pipeline support","public protocol ActionHandler: ActionHandler {","    \/\/\/ Validate if the action can be performed","    func validate(command: Command, engine: GameEngine) async throws","","    \/\/\/ Process the action and return detailed results","    func process(command: Command, engine: GameEngine) async throws -> ActionResult","","    \/\/\/ Handle any post-action effects","    func postProcess(command: Command, engine: GameEngine, result: ActionResult) async throws","}","","\/\/\/ Result of an action execution with enhanced information","public struct ActionResult {","    \/\/\/ Whether the action was successful","    public let success: Bool","","    \/\/\/ Message to display to the player","    public let message: String","","    \/\/\/ Any state changes that occurred","    public let stateChanges: [StateChange]","","    \/\/\/ Any side effects that need to be processed","    public let sideEffects: [SideEffect]","}","","\/\/\/ Represents a change in game state","public struct StateChange {","    \/\/\/ The object being changed","    public let objectId: ItemID","","    \/\/\/ The property being modified","    public let property: String","","    \/\/\/ The new value","    public let value: AnyCodable","}","","\/\/\/ Represents a side effect of an action","public struct SideEffect {","    \/\/\/ The type of side effect","    public let type: SideEffectType","","    \/\/\/ The target of the effect","    public let target: ItemID","","    \/\/\/ Any additional parameters","    public let parameters: [String: AnyCodable]","}"]},{"text":"2. Dynamic Logic & State System","anchor":"2-Dynamic-Logic--State-System","type":"heading","level":3},{"inlineContent":[{"type":"text","text":"This system allows associating dynamic computation and validation logic with specific properties of Items or Locations, while storing the actual state values separately."}],"type":"paragraph"},{"syntax":"swift","code":["\/\/\/ A strongly-typed identifier for game properties.","public struct AttributeID: Hashable, Codable, Sendable { \/* ... *\/ }","","\/\/\/ The standard type for storing potentially dynamic state values.","public enum StateValue: Codable, Sendable { \/* ... *\/ }","","\/\/ --- Game Developer Interaction Points ---","","\/\/\/ Items store their specific state values using AttributeID keys.","\/\/\/ (Example structure - actual might differ slightly)","public struct Item: Sendable, Codable {","    \/\/ ... other properties ...","    public var attributes: [AttributeID: StateValue]","}","","\/\/\/ Locations also store their state values.","public struct Location: Sendable, Codable {","    \/\/ ... other properties ...","    public var attributes: [AttributeID: StateValue]","}","","\/\/\/ Registry for dynamic behavior (part of GameBlueprint or DefinitionRegistry).","public struct DynamicAttributeRegistry: Sendable {","    \/\/\/ Closure type for computing an item property's value.","    public typealias ItemComputeHandler =","        (@Sendable (Item, GameState) -> StateValue)","    \/\/\/ Closure type for validating a new value for an item property.","    public typealias ItemValidateHandler =","        (@Sendable (Item, StateValue) -> Bool)","","    \/\/ ... Similar types for Location handlers ...","","    \/\/\/ Registers a compute handler for a specific item property.","    public func registerItemCompute(","        key: AttributeID,","        handler: @escaping ItemComputeHandler","    ) { \/* ... *\/ }","","    \/\/\/ Registers a validation handler for a specific item property.","    public func registerItemValidate(","        key: AttributeID,","        handler: @escaping ItemValidateHandler","    ) { \/* ... *\/ }","","    \/\/ ... Methods to retrieve handlers ...","}","","\/\/\/ Engine provides helpers to access values (handles registry lookup + state access).","public class GameEngine: Sendable {","    \/\/\/ Gets the current value, checking compute handlers first.","    public func getDynamicItemValue(","        itemID: ItemID,","        key: AttributeID","    ) async -> StateValue? { \/* ... *\/ }","","    \/\/\/ Sets a value after checking validate handlers and applying a StateChange.","    public func setDynamicItemValue(","        itemID: ItemID,","        key: AttributeID,","        newValue: StateValue","    ) async throws { \/* ... *\/ }","","    \/\/ ... Similar helpers for Locations ...","}"],"type":"codeListing"},{"type":"heading","anchor":"3-Action-Context-System","text":"3. Action Context System","level":3},{"type":"codeListing","code":["\/\/\/ Context for action execution","public struct ActionContext {","    \/\/\/ The command being executed","    public let command: Command","","    \/\/\/ The game engine instance","    public let engine: GameEngine","","    \/\/\/ The current game state","    public let state: GameState","","    \/\/\/ Any additional context data","    public let contextData: [String: AnyCodable]","}","","\/\/\/ Protocol for objects that can provide action context","public protocol ActionContextProvider {","    \/\/\/ Get context for an action","    func getContext(for command: Command) async throws -> ActionContext","}"],"syntax":"swift"},{"text":"Implementation Phases","level":2,"type":"heading","anchor":"Implementation-Phases"},{"level":3,"text":"Phase 1: Core Enhancements","type":"heading","anchor":"Phase-1-Core-Enhancements"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Extend "},{"type":"codeVoice","code":"ActionHandler"},{"type":"text","text":" protocol with pipeline support"}]}],"checked":true},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"text":"Implement ","type":"text"},{"type":"codeVoice","code":"ActionResult"},{"text":" and related types","type":"text"}]}]},{"checked":true,"content":[{"inlineContent":[{"text":"Add state change tracking to ","type":"text"},{"type":"codeVoice","code":"GameState"}],"type":"paragraph"}]}]},{"level":3,"anchor":"Phase-2-Dynamic-Logic--State-System","type":"heading","text":"Phase 2: Dynamic Logic & State System"},{"items":[{"checked":true,"content":[{"inlineContent":[{"type":"text","text":"Define "},{"code":"AttributeID","type":"codeVoice"},{"type":"text","text":" type."}],"type":"paragraph"}]},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"text":"Create ","type":"text"},{"type":"codeVoice","code":"DynamicAttributeRegistry"},{"text":" for compute\/validate handlers.","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Add "},{"type":"codeVoice","code":"attributes: [AttributeID: StateValue]"},{"text":" to ","type":"text"},{"type":"codeVoice","code":"Item"},{"type":"text","text":" and "},{"code":"Location","type":"codeVoice"},{"text":".","type":"text"}],"type":"paragraph"}],"checked":true},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Update "},{"type":"codeVoice","code":"StatePropertyKey"},{"type":"text","text":" and "},{"code":"GameState.apply","type":"codeVoice"},{"type":"text","text":" to handle changes to "},{"type":"codeVoice","code":"attributes"},{"type":"text","text":"."}]}]},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"text":"Implement ","type":"text"},{"type":"codeVoice","code":"GameEngine"},{"type":"text","text":" helpers ("},{"code":"get\/setDynamic...Value","type":"codeVoice"},{"text":") to orchestrate registry\/state access.","type":"text"}]}]}],"type":"unorderedList"},{"type":"heading","anchor":"Phase-3-Context-System","level":3,"text":"Phase 3: Context System"},{"items":[{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"text":"Implement ","type":"text"},{"type":"codeVoice","code":"ActionContext"},{"type":"text","text":" system"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Add context providers for common scenarios","type":"text"}]}],"checked":true},{"checked":true,"content":[{"inlineContent":[{"type":"text","text":"Integrate with existing action handlers"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"heading","level":3,"text":"Phase 4: Migration","anchor":"Phase-4-Migration"},{"type":"unorderedList","items":[{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Update existing action handlers to use new system"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Add support for dynamic descriptions","type":"text"}]}],"checked":true},{"content":[{"inlineContent":[{"text":"Implement state-dependent behavior","type":"text"}],"type":"paragraph"}],"checked":true}]},{"anchor":"Testing-Strategy","text":"Testing Strategy","type":"heading","level":2},{"items":[{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Unit Tests"}]}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Test enhanced action handlers"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Verify dynamic properties","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Check context system","type":"text"}]}]}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Integration Tests"}]}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Test action pipeline"}]}]},{"content":[{"inlineContent":[{"text":"Verify state changes","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Check side effects","type":"text"}]}]}]}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Migration Tests"}]}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Verify existing functionality"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Test new features"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Check performance impact","type":"text"}],"type":"paragraph"}]}]}]}],"type":"orderedList"},{"anchor":"Migration-Guide","type":"heading","level":2,"text":"Migration Guide"},{"type":"heading","level":3,"text":"For Action Handlers","anchor":"For-Action-Handlers"},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Simple Migration"}]}]}]}]},{"type":"codeListing","syntax":"swift","code":["\/\/ Before","public struct SimpleActionHandler: ActionHandler {","    func perform(command: Command, engine: GameEngine) async throws {","        \/\/ Implementation","    }","}","","\/\/ After","public struct ActionHandler: ActionHandler {","    func perform(command: Command, engine: GameEngine) async throws {","        try await validate(command: command, engine: engine)","        let result = try await process(command: command, engine: engine)","        try await postProcess(command: command, engine: engine, result: result)","    }","","    \/\/ New methods","    func validate(command: Command, engine: GameEngine) async throws {","        \/\/ Validation logic","    }","","    func process(command: Command, engine: GameEngine) async throws -> ActionResult {","        \/\/ Processing logic","    }","","    func postProcess(command: Command, engine: GameEngine, result: ActionResult) async throws {","        \/\/ Post-processing logic","    }","}"]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Dynamic Properties"}]}]}]}],"type":"orderedList","start":2},{"code":["\/\/ Before","item.attributes[\"isOpen\"] = true","","\/\/ After (Conceptual Example)","\/\/ 1. Define AttributeID","\/\/ extension AttributeID { static let isOpen = AttributeID(\"isOpen\") }","\/\/ 2. Register validation handler (optional, during setup)","\/\/ registry.registerItemValidate(key: .isOpen) { item, newValue in ... }","\/\/ 3. Set value using engine helper (triggers validation & StateChange)","\/\/ try await engine.setDynamicItemValue(itemID: item.id, key: .isOpen, newValue: true,)","\/\/ 4. Get value using engine helper (checks compute handlers)","\/\/ let isOpen = await engine.getDynamicItemValue(itemID: item.id, key: .isOpen)?.toBool ?? false"],"type":"codeListing","syntax":"swift"},{"text":"Conclusion","level":2,"type":"heading","anchor":"Conclusion"},{"inlineContent":[{"type":"text","text":"This enhanced design builds upon the existing Gnusto engine architecture while introducing more powerful capabilities for dynamic content and action handling. The design maintains backward compatibility while providing a path forward for more sophisticated game mechanics."}],"type":"paragraph"}]}],"identifier":{"url":"doc:\/\/GnustoEngine\/documentation\/GnustoEngine\/ENHANCED_ACTION_HANDLING","interfaceLanguage":"swift"},"metadata":{"title":"Enhanced Action Handling System Design [DONE]","modules":[{"name":"GnustoEngine"}],"roleHeading":"Article","role":"article"},"kind":"article","schemaVersion":{"patch":0,"major":0,"minor":3},"sections":[],"references":{"doc://GnustoEngine/documentation/GnustoEngine":{"url":"\/documentation\/gnustoengine","role":"collection","abstract":[],"title":"GnustoEngine","kind":"symbol","type":"topic","identifier":"doc:\/\/GnustoEngine\/documentation\/GnustoEngine"}}}