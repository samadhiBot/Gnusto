{"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/GnustoEngine\/documentation\/GnustoEngine\/ENHANCED_ACTION_HANDLING"},"kind":"article","sections":[],"schemaVersion":{"major":0,"minor":3,"patch":0},"metadata":{"role":"article","roleHeading":"Article","modules":[{"name":"GnustoEngine"}],"title":"Enhanced Action Handling System Design [DONE]"},"variants":[{"paths":["\/documentation\/gnustoengine\/enhanced_action_handling"],"traits":[{"interfaceLanguage":"swift"}]}],"hierarchy":{"paths":[["doc:\/\/GnustoEngine\/documentation\/GnustoEngine"]]},"primaryContentSections":[{"content":[{"anchor":"Overview","level":2,"type":"heading","text":"Overview"},{"type":"paragraph","inlineContent":[{"type":"text","text":"This document outlines the design for enhancing the existing Gnusto engineâ€™s action handling system. The goal is to build upon the current solid foundation while introducing more powerful capabilities for dynamic content and action handling."}]},{"type":"heading","text":"Current Architecture Analysis","level":2,"anchor":"Current-Architecture-Analysis"},{"type":"heading","anchor":"Existing-Components","text":"Existing Components","level":3},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"inlineContent":[{"type":"text","text":"Action Handling"}],"type":"strong"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"code":"ActionHandler","type":"codeVoice"},{"text":" protocol with ","type":"text"},{"type":"codeVoice","code":"perform(command:engine:)"},{"type":"text","text":" method"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"code":"ItemEventHandler","type":"codeVoice"},{"text":" type for item-specific actions","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Well-organized action handlers for common verbs","type":"text"}]}]}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"State Management"}]}]},{"items":[{"content":[{"inlineContent":[{"code":"GameState","type":"codeVoice"},{"text":" class for overall game state","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"Item"},{"text":" and ","type":"text"},{"type":"codeVoice","code":"Location"},{"type":"text","text":" types with properties"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"code":"AnyCodable","type":"codeVoice"},{"text":" for flexible property values","type":"text"}]}]}],"type":"unorderedList"}]},{"content":[{"inlineContent":[{"inlineContent":[{"type":"text","text":"Command Processing"}],"type":"strong"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"code":"Command","type":"codeVoice"},{"type":"text","text":" type for representing player actions"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"ScopeResolver"},{"type":"text","text":" for object resolution"}]}]}],"type":"unorderedList"}]}]},{"level":2,"anchor":"Enhancement-Strategy","type":"heading","text":"Enhancement Strategy"},{"text":"1. Action Pipeline Enhancement","type":"heading","level":3,"anchor":"1-Action-Pipeline-Enhancement"},{"type":"codeListing","syntax":"swift","code":["\/\/\/ Enhanced ActionHandler protocol with pipeline support","public protocol ActionHandler: ActionHandler {","    \/\/\/ Validate if the action can be performed","    func validate(command: Command, engine: GameEngine) async throws","","    \/\/\/ Process the action and return detailed results","    func process(command: Command, engine: GameEngine) async throws -> ActionResult","","    \/\/\/ Handle any post-action effects","    func postProcess(command: Command, engine: GameEngine, result: ActionResult) async throws","}","","\/\/\/ Result of an action execution with enhanced information","public struct ActionResult {","    \/\/\/ Whether the action was successful","    public let success: Bool","","    \/\/\/ Message to display to the player","    public let message: String","","    \/\/\/ Any state changes that occurred","    public let stateChanges: [StateChange]","","    \/\/\/ Any side effects that need to be processed","    public let sideEffects: [SideEffect]","}","","\/\/\/ Represents a change in game state","public struct StateChange {","    \/\/\/ The object being changed","    public let objectId: ItemID","","    \/\/\/ The property being modified","    public let property: String","","    \/\/\/ The new value","    public let value: AnyCodable","}","","\/\/\/ Represents a side effect of an action","public struct SideEffect {","    \/\/\/ The type of side effect","    public let type: SideEffectType","","    \/\/\/ The target of the effect","    public let target: ItemID","","    \/\/\/ Any additional parameters","    public let parameters: [String: AnyCodable]","}"]},{"level":3,"anchor":"2-Dynamic-Logic--State-System","text":"2. Dynamic Logic & State System","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"This system allows associating dynamic computation and validation logic with specific properties of Items or Locations, while storing the actual state values separately.","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["\/\/\/ A strongly-typed identifier for game properties.","public struct AttributeID: Hashable, Codable, Sendable { \/* ... *\/ }","","\/\/\/ The standard type for storing potentially dynamic state values.","public enum StateValue: Codable, Sendable { \/* ... *\/ }","","\/\/ --- Game Developer Interaction Points ---","","\/\/\/ Items store their specific state values using AttributeID keys.","\/\/\/ (Example structure - actual might differ slightly)","public struct Item: Sendable, Codable {","    \/\/ ... other properties ...","    public var attributes: [AttributeID: StateValue]","}","","\/\/\/ Locations also store their state values.","public struct Location: Sendable, Codable {","    \/\/ ... other properties ...","    public var attributes: [AttributeID: StateValue]","}","","\/\/\/ Registry for dynamic behavior (part of GameBlueprint or DefinitionRegistry).","public struct DynamicAttributeRegistry: Sendable {","    \/\/\/ Closure type for computing an item property's value.","    public typealias ItemComputeHandler =","        (@Sendable (Item, GameState) -> StateValue)","    \/\/\/ Closure type for validating a new value for an item property.","    public typealias ItemValidateHandler =","        (@Sendable (Item, StateValue) -> Bool)","","    \/\/ ... Similar types for Location handlers ...","","    \/\/\/ Registers a compute handler for a specific item property.","    public func registerItemCompute(","        key: AttributeID,","        handler: @escaping ItemComputeHandler","    ) { \/* ... *\/ }","","    \/\/\/ Registers a validation handler for a specific item property.","    public func registerItemValidate(","        key: AttributeID,","        handler: @escaping ItemValidateHandler","    ) { \/* ... *\/ }","","    \/\/ ... Methods to retrieve handlers ...","}","","\/\/\/ Engine provides helpers to access values (handles registry lookup + state access).","public class GameEngine: Sendable {","    \/\/\/ Gets the current value, checking compute handlers first.","    public func getDynamicItemValue(","        itemID: ItemID,","        key: AttributeID","    ) async -> StateValue? { \/* ... *\/ }","","    \/\/\/ Sets a value after checking validate handlers and applying a StateChange.","    public func setDynamicItemValue(","        itemID: ItemID,","        key: AttributeID,","        newValue: StateValue","    ) async throws { \/* ... *\/ }","","    \/\/ ... Similar helpers for Locations ...","}"]},{"level":3,"type":"heading","text":"3. Action Context System","anchor":"3-Action-Context-System"},{"code":["\/\/\/ Context for action execution","public struct ActionContext {","    \/\/\/ The command being executed","    public let command: Command","","    \/\/\/ The game engine instance","    public let engine: GameEngine","","    \/\/\/ The current game state","    public let state: GameState","","    \/\/\/ Any additional context data","    public let contextData: [String: AnyCodable]","}","","\/\/\/ Protocol for objects that can provide action context","public protocol ActionContextProvider {","    \/\/\/ Get context for an action","    func getContext(for command: Command) async throws -> ActionContext","}"],"syntax":"swift","type":"codeListing"},{"type":"heading","anchor":"Implementation-Phases","level":2,"text":"Implementation Phases"},{"type":"heading","anchor":"Phase-1-Core-Enhancements","level":3,"text":"Phase 1: Core Enhancements"},{"items":[{"content":[{"inlineContent":[{"text":"Extend ","type":"text"},{"type":"codeVoice","code":"ActionHandler"},{"type":"text","text":" protocol with pipeline support"}],"type":"paragraph"}],"checked":true},{"checked":true,"content":[{"inlineContent":[{"type":"text","text":"Implement "},{"code":"ActionResult","type":"codeVoice"},{"type":"text","text":" and related types"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Add state change tracking to ","type":"text"},{"code":"GameState","type":"codeVoice"}]}],"checked":true}],"type":"unorderedList"},{"level":3,"anchor":"Phase-2-Dynamic-Logic--State-System","text":"Phase 2: Dynamic Logic & State System","type":"heading"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Define "},{"type":"codeVoice","code":"AttributeID"},{"type":"text","text":" type."}],"type":"paragraph"}],"checked":true},{"content":[{"type":"paragraph","inlineContent":[{"text":"Create ","type":"text"},{"code":"DynamicAttributeRegistry","type":"codeVoice"},{"text":" for compute\/validate handlers.","type":"text"}]}],"checked":true},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Add "},{"code":"attributes: [AttributeID: StateValue]","type":"codeVoice"},{"type":"text","text":" to "},{"type":"codeVoice","code":"Item"},{"text":" and ","type":"text"},{"type":"codeVoice","code":"Location"},{"type":"text","text":"."}]}]},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Update "},{"type":"codeVoice","code":"StatePropertyKey"},{"type":"text","text":" and "},{"code":"GameState.apply","type":"codeVoice"},{"type":"text","text":" to handle changes to "},{"code":"attributes","type":"codeVoice"},{"text":".","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Implement "},{"code":"GameEngine","type":"codeVoice"},{"text":" helpers (","type":"text"},{"type":"codeVoice","code":"get\/setDynamic...Value"},{"text":") to orchestrate registry\/state access.","type":"text"}]}],"checked":true}],"type":"unorderedList"},{"anchor":"Phase-3-Context-System","level":3,"type":"heading","text":"Phase 3: Context System"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Implement "},{"code":"ActionContext","type":"codeVoice"},{"text":" system","type":"text"}],"type":"paragraph"}],"checked":true},{"content":[{"inlineContent":[{"type":"text","text":"Add context providers for common scenarios"}],"type":"paragraph"}],"checked":true},{"content":[{"inlineContent":[{"type":"text","text":"Integrate with existing action handlers"}],"type":"paragraph"}],"checked":true}],"type":"unorderedList"},{"type":"heading","anchor":"Phase-4-Migration","level":3,"text":"Phase 4: Migration"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Update existing action handlers to use new system","type":"text"}],"type":"paragraph"}],"checked":true},{"checked":true,"content":[{"inlineContent":[{"type":"text","text":"Add support for dynamic descriptions"}],"type":"paragraph"}]},{"checked":true,"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Implement state-dependent behavior"}]}]}]},{"anchor":"Testing-Strategy","type":"heading","text":"Testing Strategy","level":2},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Unit Tests"}]}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Test enhanced action handlers"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Verify dynamic properties"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Check context system","type":"text"}]}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"Integration Tests","type":"text"}]}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Test action pipeline"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Verify state changes"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Check side effects"}],"type":"paragraph"}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"Migration Tests","type":"text"}],"type":"strong"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Verify existing functionality"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Test new features","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Check performance impact","type":"text"}]}]}],"type":"unorderedList"}]}]},{"text":"Migration Guide","anchor":"Migration-Guide","level":2,"type":"heading"},{"text":"For Action Handlers","level":3,"type":"heading","anchor":"For-Action-Handlers"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"Simple Migration","type":"text"}],"type":"strong"}]}]}],"type":"orderedList"},{"code":["\/\/ Before","public struct SimpleActionHandler: ActionHandler {","    func perform(command: Command, engine: GameEngine) async throws {","        \/\/ Implementation","    }","}","","\/\/ After","public struct ActionHandler: ActionHandler {","    func perform(command: Command, engine: GameEngine) async throws {","        try await validate(command: command, engine: engine)","        let result = try await process(command: command, engine: engine)","        try await postProcess(command: command, engine: engine, result: result)","    }","","    \/\/ New methods","    func validate(command: Command, engine: GameEngine) async throws {","        \/\/ Validation logic","    }","","    func process(command: Command, engine: GameEngine) async throws -> ActionResult {","        \/\/ Processing logic","    }","","    func postProcess(command: Command, engine: GameEngine, result: ActionResult) async throws {","        \/\/ Post-processing logic","    }","}"],"syntax":"swift","type":"codeListing"},{"type":"orderedList","start":2,"items":[{"content":[{"inlineContent":[{"inlineContent":[{"text":"Dynamic Properties","type":"text"}],"type":"strong"}],"type":"paragraph"}]}]},{"type":"codeListing","code":["\/\/ Before","item.attributes[\"isOpen\"] = true","","\/\/ After (Conceptual Example)","\/\/ 1. Define AttributeID","\/\/ extension AttributeID { static let isOpen = AttributeID(\"isOpen\") }","\/\/ 2. Register validation handler (optional, during setup)","\/\/ registry.registerItemValidate(key: .isOpen) { item, newValue in ... }","\/\/ 3. Set value using engine helper (triggers validation & StateChange)","\/\/ try await engine.setDynamicItemValue(itemID: item.id, key: .isOpen, newValue: true,)","\/\/ 4. Get value using engine helper (checks compute handlers)","\/\/ let isOpen = await engine.getDynamicItemValue(itemID: item.id, key: .isOpen)?.toBool ?? false"],"syntax":"swift"},{"text":"Conclusion","anchor":"Conclusion","level":2,"type":"heading"},{"inlineContent":[{"type":"text","text":"This enhanced design builds upon the existing Gnusto engine architecture while introducing more powerful capabilities for dynamic content and action handling. The design maintains backward compatibility while providing a path forward for more sophisticated game mechanics."}],"type":"paragraph"}],"kind":"content"}],"references":{"doc://GnustoEngine/documentation/GnustoEngine":{"type":"topic","identifier":"doc:\/\/GnustoEngine\/documentation\/GnustoEngine","abstract":[],"url":"\/documentation\/gnustoengine","title":"GnustoEngine","role":"collection","kind":"symbol"}}}